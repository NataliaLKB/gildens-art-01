<!DOCTYPE html>
<html>
<head>
	<style>
        p {
            font-size: 20px;
            font-family: Arial;
            color: #fff;
        }
        #overlay {
            position: absolute;
            text-align: center;
            padding: 50px;
            margin-left: 50px;
        }
    </style>
    <title>Planet3/art//news</title>
    <script>
    // To do: 
    // - Random selection of images.
    // - Testing
    // - Mobile responsive?

        var difficulty = 1;
        var hoverTint = '#009900';

        var levelCounter = 0;

        var stage;
        var canvas;

        var img;
        var pieces;
        var puzzleWidth;
        var puzzleHeight;
        var pieceWidth;
        var pieceHeight;
        var currentPiece;
        var currentDropPiece;

        var mouse;

        //Called at the start of every new game and Level
        function init (){
        	difficulty +=1;
            levelCounter +=1;

            img = new Image();
            img.addEventListener('load',onImage,false);
          
            img.src = pickImg();
        }
        //Need to finish... One pictures are received
        function pickImg (){
            return "./img/full.jpg";
        }

        function onImage (){
            pieceWidth = Math.floor(img.width / difficulty)
            pieceHeight = Math.floor(img.height / difficulty)
            puzzleWidth = pieceWidth * difficulty;
            puzzleHeight = pieceHeight * difficulty;
            setCanvas();
            initPuzzle();
        }

        function setCanvas (){
            canvas = document.getElementById('canvas');
            stage = canvas.getContext('2d');
            canvas.width = puzzleWidth;
            canvas.height = puzzleHeight;
            canvas.style.border = "1px solid black";
        }

        function initPuzzle (){
            pieces = [];
            mouse = {x:0,y:0};
            currentPiece = null;
            currentDropPiece = null;
            stage.drawImage(img, 0, 0, puzzleWidth, puzzleHeight, 0, 0, puzzleWidth, puzzleHeight);
            if (levelCounter === 1) {
                createTitle("Click to Start");
            } else {
                createDomMessage("<p id='deleteMe'>Congratulations! You finished Level " + 
                    (levelCounter - 1) + " in " + movesCounter + " moves!</p>");
                createDomMessage("<p id='deleteMe'>Ready for the Next Puzzle?</p>");
                createTitle("Click to Start");
            }
            buildPieces();
            //resets movesCounter between levels
            movesCounter = 0;
        }
        function createDomMessage (message) {
            overlayWidth = "300px";//canvas.width - 200;
            document.getElementById("overlay").style["width"] = overlayWidth;
            document.getElementById("overlay").style["top"] = "300px";
            document.getElementById("overlay").style["background-color"] = "rgba(0,0,0,0.4)";

            var parser = new DOMParser()
            var parsedHtml = parser.parseFromString(message, "text/html");
            var HTML = parsedHtml.childNodes[0];
            
            var parsedMessage = HTML.childNodes[1];
            document.getElementById("message").appendChild(parsedMessage.childNodes[0]);
        }

        function deleteDomMessage (id) {
            $('#'+id).remove();
            document.getElementById("overlay").style["background-color"] = "rgba(0,0,0,0)";
            document.getElementById("overlay").style["top"] = "0";
        }
        function createMessage (message){
            stage.fillStyle = "#000000";
            stage.globalAlpha = .4;
            stage.fillRect(50, 50 ,puzzleWidth - 100, puzzleHeight - 200);
            stage.fillStyle = "#FFFFFF";
            stage.globalAlpha = 1;
            stage.textAlign = "center";
            stage.textBaseline = "middle";
            stage.font = "20px Arial";
            stage.fillText(message,puzzleWidth / 2, puzzleWidth / 2, 225);
        }

        function createTitle (message){
            stage.fillStyle = "#000000";
            stage.globalAlpha = .4;
            stage.fillRect(50,puzzleHeight - 40,puzzleWidth - 100,100);
            stage.fillStyle = "#FFFFFF";
            stage.globalAlpha = 1;
            stage.textAlign = "center";
            stage.textBaseline = "middle";
            stage.font = "20px Arial";
            stage.fillText(message,puzzleWidth / 2,puzzleHeight - 20);
        }

        function buildPieces (){
            var i;
            var piece;
            var xPos = 0;
            var yPos = 0;
            for(i = 0;i < difficulty * difficulty;i++){
                piece = {};
                piece.sx = xPos;
                piece.sy = yPos;
                pieces.push(piece);
                xPos += pieceWidth;
                if(xPos >= puzzleWidth){
                    xPos = 0;
                    yPos += pieceHeight;
                }
            }
            document.onmousedown = shufflePuzzle;
        }
        function shufflePuzzle (){
            deleteDomMessage("deleteMe");
            deleteDomMessage("deleteMe");

            pieces = shuffleArrayPieces(pieces);
            stage.clearRect(0,0,puzzleWidth,puzzleHeight);
            var i;
            var piece;
            var xPos = 0;
            var yPos = 0;
            for(i = 0;i < pieces.length;i++){
                piece = pieces[i];
                piece.xPos = xPos;
                piece.yPos = yPos;
                stage.drawImage(img, piece.sx, piece.sy, pieceWidth, pieceHeight, xPos, yPos, pieceWidth, pieceHeight);
                stage.strokeRect(xPos, yPos, pieceWidth,pieceHeight);
                xPos += pieceWidth;
                if(xPos >= puzzleWidth){
                    xPos = 0;
                    yPos += pieceHeight;
                }
            }
            document.onmousedown = onPuzzleClick;
        }
        function onPuzzleClick (e){
            if(e.layerX || e.layerX == 0){
                mouse.x = e.layerX - canvas.offsetLeft;
                mouse.y = e.layerY - canvas.offsetTop;
            }
            else if(e.offsetX || e.offsetX == 0){
                mouse.x = e.offsetX - canvas.offsetLeft;
                mouse.y = e.offsetY - canvas.offsetTop;
            }
            currentPiece = checkPieceClicked();
            if(currentPiece != null){
                stage.clearRect(currentPiece.xPos,currentPiece.yPos,pieceWidth,pieceHeight);
                stage.save();
                stage.globalAlpha = .9;
                stage.drawImage(img, currentPiece.sx, currentPiece.sy, pieceWidth, pieceHeight, mouse.x - (pieceWidth / 2), mouse.y - (pieceHeight / 2), pieceWidth, pieceHeight);
                stage.restore();
                document.onmousemove = updatePuzzle;
                document.onmouseup = pieceDropped;
            }
        }
        function checkPieceClicked (){
            var i;
            var piece;
            for(i = 0;i < pieces.length;i++){
                piece = pieces[i];
                if(mouse.x < piece.xPos || mouse.x > (piece.xPos + pieceWidth) || mouse.y < piece.yPos || mouse.y > (piece.yPos + pieceHeight)){
                    //PIECE NOT HIT
                }
                else{
                    return piece;
                }
            }
            return null;
        }
        function updatePuzzle (e){
            currentDropPiece = null;
            if(e.layerX || e.layerX == 0){
                mouse.x = e.layerX - canvas.offsetLeft;
                mouse.y = e.layerY - canvas.offsetTop;
            }
            else if(e.offsetX || e.offsetX == 0){
                mouse.x = e.offsetX - canvas.offsetLeft;
                mouse.y = e.offsetY - canvas.offsetTop;
            }
            stage.clearRect(0,0,puzzleWidth,puzzleHeight);
            var i;
            var piece;
            for(i = 0;i < pieces.length;i++){
                piece = pieces[i];
                if(piece == currentPiece){
                    continue;
                }
                stage.drawImage(img, piece.sx, piece.sy, pieceWidth, pieceHeight, piece.xPos, piece.yPos, pieceWidth, pieceHeight);
                stage.strokeRect(piece.xPos, piece.yPos, pieceWidth,pieceHeight);
                if(currentDropPiece == null){
                    if(mouse.x < piece.xPos || mouse.x > (piece.xPos + pieceWidth) || mouse.y < piece.yPos || mouse.y > (piece.yPos + pieceHeight)){
                        //NOT OVER
                    }
                    else{
                        currentDropPiece = piece;
                        stage.save();
                        stage.globalAlpha = .4;
                        stage.fillStyle = hoverTint;
                        stage.fillRect(currentDropPiece.xPos,currentDropPiece.yPos,pieceWidth, pieceHeight);
                        stage.restore();
                    }
                }
            }
            stage.save();
            stage.globalAlpha = .6;
            stage.drawImage(img, currentPiece.sx, currentPiece.sy, pieceWidth, pieceHeight, mouse.x - (pieceWidth / 2), mouse.y - (pieceHeight / 2), pieceWidth, pieceHeight);
            stage.restore();
            stage.strokeRect( mouse.x - (pieceWidth / 2), mouse.y - (pieceHeight / 2), pieceWidth,pieceHeight);
        }
        function pieceDropped (e){
            //Counts number of moves in each level
            movesCounter +=1;

            document.onmousemove = null;
            document.onmouseup = null;
            if(currentDropPiece != null){
                var tmp = {xPos:currentPiece.xPos,yPos:currentPiece.yPos};
                currentPiece.xPos = currentDropPiece.xPos;
                currentPiece.yPos = currentDropPiece.yPos;
                currentDropPiece.xPos = tmp.xPos;
                currentDropPiece.yPos = tmp.yPos;
            }
            resetPuzzleAndCheckWin();
        }
        function resetPuzzleAndCheckWin (){
            stage.clearRect(0,0,puzzleWidth,puzzleHeight);
            var gameWin = true;
            var i;
            var piece;

            for(i = 0;i < pieces.length;i++){
                piece = pieces[i];
                stage.drawImage(img, piece.sx, piece.sy, pieceWidth, pieceHeight, piece.xPos, piece.yPos, pieceWidth, pieceHeight);
                stage.strokeRect(piece.xPos, piece.yPos, pieceWidth,pieceHeight);
                if(piece.xPos != piece.sx || piece.yPos != piece.sy){
                    gameWin = false;
                }
            }
            if(gameWin){
                setTimeout(gameOver,500);
            }
        }
        function gameOver (){
            document.onmousedown = null;
            document.onmousemove = null;
            document.onmouseup = null;

            if (levelCounter < 6 ) {
                init();
            } else {
                createMessage("You Won the Game!");
            }
        }
        function shuffleArrayPieces (pieces){
            for(var j, x, i = pieces.length; i; j = parseInt(Math.random() * i), x = pieces[--i], pieces[i] = pieces[j], pieces[j] = x);
            return pieces;
        }

    </script>
</head>

<body onload="init();">
    <br><br>
    <div id="overlay">
        <div id="message"></div>
    </div>
    <canvas id="canvas"></canvas>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
</html>